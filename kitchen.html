<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DANDY - –ö—É—Ö–Ω—è</title>
    <style>
        :root {
            --dandy-green: #04746c;
            --primary: #08615b;
            --secondary: #00706c;
            --dandy-bg: #08615b;
            --dandy-card: #094a45;
            --dandy-yellow: #e4bc6c;
            --accent: #eebc5c;
            --text-light: #F3EADB;
            --text-on-green: #F3EADB;
            --urgent: #dc2626;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--dandy-green);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--dandy-bg);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            color: var(--dandy-yellow);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--dandy-yellow);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .current-time {
            font-size: 28px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--dandy-card);
            padding: 15px 30px;
            gap: 15px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 35px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--dandy-yellow);
            color: var(--dandy-green);
            border-color: var(--dandy-yellow);
            transform: translateY(-2px);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.15);
        }

        /* Orders Grid */
        .orders-container {
            padding: 30px;
            height: calc(100vh - 220px);
            overflow-y: auto;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
        }

        /* Order Card */
        .order-card {
            background: var(--dandy-card);
            border-radius: 16px;
            padding: 25px;
            border-left: 8px solid var(--dandy-yellow);
            transition: all 0.3s;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .order-card.urgent {
            border-left-color: var(--urgent);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(220, 38, 38, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .order-number {
            font-size: 28px;
            font-weight: 900;
            color: var(--dandy-yellow);
        }

        .order-time {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-light);
        }

        .order-time.urgent {
            color: var(--urgent);
        }

        .order-items {
            margin: 20px 0;
        }

        .order-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        .item-name {
            font-weight: 600;
        }

        .item-qty {
            background: var(--dandy-yellow);
            color: var(--dandy-green);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 20px;
        }

        .order-notes {
            background: rgba(255, 193, 7, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .order-notes-title {
            font-weight: 700;
            margin-bottom: 5px;
            color: #ffc107;
        }

        /* Action Buttons */
        .order-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-ready {
            background: var(--success);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-ready:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-delay {
            background: var(--warning);
            color: white;
        }

        .btn-problem {
            background: var(--urgent);
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.6);
        }

        .empty-icon {
            font-size: 120px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 32px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .orders-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo {
                font-size: 24px;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sound Toggle */
        .sound-toggle {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sound-toggle.active {
            background: var(--success);
            border-color: var(--success);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">üçï DANDY –ö–£–•–ù–Ø</div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="ordersCount">0</div>
                <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgTime">0</div>
                <div class="stat-label">–ú–∏–Ω. —Å—Ä–µ–¥–Ω–µ–µ</div>
            </div>
            <div class="current-time" id="currentTime"></div>
            <button class="sound-toggle active" id="soundToggle" onclick="toggleSound()">
                üîî –ó–≤—É–∫
            </button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-station="all">–í—Å–µ –∑–∞–∫–∞–∑—ã</button>
        <button class="tab-btn" data-station="pizza">üçï –ü–∏—Ü—Ü–∞</button>
        <button class="tab-btn" data-station="sushi">üç£ –°—É—à–∏</button>
        <button class="tab-btn" data-station="hot">üî• –ì–æ—Ä—è—á–µ–µ</button>
        <button class="tab-btn" data-station="cold">ü•ó –•–æ–ª–æ–¥–Ω–æ–µ</button>
        <button class="tab-btn" data-station="drinks">ü•§ –ù–∞–ø–∏—Ç–∫–∏</button>
        <button class="tab-btn" data-station="desserts">üç∞ –î–µ—Å–µ—Ä—Ç—ã</button>
    </div>

    <!-- Orders Container -->
    <div class="orders-container">
        <div class="orders-grid" id="ordersGrid">
            <!-- Orders will be loaded here -->
        </div>
    </div>

    <!-- Load KDS Module -->
    <script src="modules/kds-advanced.js"></script>
    <script src="modules/sound-notifications.js"></script>

    <script>
        // ========== KITCHEN DISPLAY SYSTEM ==========
        
        let currentStation = 'all';
        let orders = [];
        let soundEnabled = true;

        // Initialize
        async function init() {
            updateTime();
            setInterval(updateTime, 1000);
            
            setupTabs();
            await loadOrders();
            
            // Auto-refresh every 10 seconds
            setInterval(loadOrders, 10000);
        }

        // Update clock
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }

        // Setup station tabs
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentStation = tab.dataset.station;
                    renderOrders();
                });
            });
        }

        // Load orders from API
        async function loadOrders() {
            try {
                const response = await fetch('/api/orders?status=preparing,accepted');
                if (response.ok) {
                    const data = await response.json();
                    const newOrders = data.data || data || [];
                    
                    // Check for new orders (play sound)
                    if (newOrders.length > orders.length && soundEnabled) {
                        playNotificationSound();
                    }
                    
                    orders = newOrders;
                    renderOrders();
                    updateStats();
                } else {
                    console.error('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                // Show demo orders for testing
                loadDemoOrders();
            }
        }

        // Load demo orders for testing
        function loadDemoOrders() {
            orders = [
                {
                    id: 'ORD-001',
                    number: '#001',
                    items: [
                        { name: '–ü–∏—Ü—Ü–∞ 4 –°—ã—Ä–∞', quantity: 1, station: 'pizza' },
                        { name: '–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', quantity: 2, station: 'pizza' }
                    ],
                    createdAt: new Date(Date.now() - 5 * 60000),
                    notes: '–ë–µ–∑ –ª—É–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
                    status: 'preparing'
                },
                {
                    id: 'ORD-002',
                    number: '#002',
                    items: [
                        { name: '–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', quantity: 2, station: 'sushi' },
                        { name: '–ö–æ–ª–∞', quantity: 1, station: 'drinks' }
                    ],
                    createdAt: new Date(Date.now() - 18 * 60000),
                    status: 'preparing'
                },
                {
                    id: 'ORD-003',
                    number: '#003',
                    items: [
                        { name: '–ß–∏–∑–∫–µ–π–∫', quantity: 1, station: 'desserts' }
                    ],
                    createdAt: new Date(Date.now() - 3 * 60000),
                    status: 'preparing'
                }
            ];
            renderOrders();
            updateStats();
        }

        // Render orders
        function renderOrders() {
            const grid = document.getElementById('ordersGrid');
            
            // Filter orders by station
            let filteredOrders = orders;
            if (currentStation !== 'all') {
                filteredOrders = orders.filter(order => 
                    order.items && order.items.some(item => item.station === currentStation)
                );
            }

            if (filteredOrders.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div class="empty-text">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredOrders.map(order => renderOrderCard(order)).join('');
        }

        // Render single order card
        function renderOrderCard(order) {
            const timeElapsed = Math.floor((Date.now() - new Date(order.createdAt)) / 60000);
            const isUrgent = timeElapsed > 20;
            const urgentClass = isUrgent ? 'urgent' : '';
            const timeClass = isUrgent ? 'urgent' : '';

            const itemsHtml = (order.items || [])
                .filter(item => currentStation === 'all' || item.station === currentStation)
                .map(item => `
                    <div class="order-item">
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty">√ó${item.quantity}</span>
                    </div>
                `).join('');

            const notesHtml = order.notes ? `
                <div class="order-notes">
                    <div class="order-notes-title">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
                    <div>${order.notes}</div>
                </div>
            ` : '';

            return `
                <div class="order-card ${urgentClass}">
                    <div class="order-header">
                        <div class="order-number">${order.number || order.id}</div>
                        <div class="order-time ${timeClass}">${timeElapsed} –º–∏–Ω</div>
                    </div>
                    
                    <div class="order-items">
                        ${itemsHtml}
                    </div>
                    
                    ${notesHtml}
                    
                    <div class="order-actions">
                        <button class="btn btn-ready" onclick="markReady('${order.id}')">
                            ‚úÖ –ì–û–¢–û–í–û
                        </button>
                    </div>
                </div>
            `;
        }

        // Mark order as ready
        async function markReady(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'ready' })
                });

                if (response.ok) {
                    // Remove from list
                    orders = orders.filter(o => o.id !== orderId);
                    renderOrders();
                    updateStats();
                    
                    // Play success sound
                    if (soundEnabled) {
                        playSuccessSound();
                    }
                }
            } catch (error) {
                console.error('Error updating order:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('ordersCount').textContent = orders.length;
            
            if (orders.length > 0) {
                const avgTime = Math.floor(
                    orders.reduce((sum, order) => {
                        return sum + (Date.now() - new Date(order.createdAt)) / 60000;
                    }, 0) / orders.length
                );
                document.getElementById('avgTime').textContent = avgTime;
            } else {
                document.getElementById('avgTime').textContent = '0';
            }
        }

        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            if (soundEnabled) {
                btn.classList.add('active');
                btn.textContent = 'üîî –ó–≤—É–∫';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üîï –ë–µ–∑ –∑–≤—É–∫–∞';
            }
        }

        // Play notification sound
        function playNotificationSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGO59e2rYBwGO5bf88x8KgYVYbTs8Khg');
            audio.play().catch(e => console.log('Sound play failed:', e));
        }

        // Play success sound
        function playSuccessSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGO59e2rYBwGO5bf88x8KgYVYbTs8Khg');
            audio.play().catch(e => console.log('Sound play failed:', e));
        }

        // Start application
        init();
    </script>
</body>
</html>

